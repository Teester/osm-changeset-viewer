<html>
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
	<style>
		body {
		  font: 15px Helvetica, arial, sans-serif;
		}

		table {
			border-collapse: collapse;
			width: 100%;
			background-color: #f2f2f2;
		}

		td, th {
			border-top: 1px solid #ddd;
			border-left: 1px solid #ddd;
			border-right: 1px solid #ddd;
			padding: 8px;
		}

		tr:hover, .selected {background-color: #ddd;}

		.toplevel {
			border: 0px;
		}

		.comment tr {
			background-color: #e2e2e2;
			border: 0px;
		}

		.subcomment {
			background-color: #f2f2f2;
			padding-left: 50px;
			font-size: 14px;
		}

		.user {
			font-size: 15px;
		}

		th {
			padding-top: 12px;
			padding-bottom: 12px;
			text-align: left;
			background-color: #4CAF50;
			color: white;
		}

		#mapid { height:400px; }

	</style>
	<title>OSM Changesets in Ireland</title>
</head>

<body>
	<h2 id="title">OSM Changesets</h2>
	<div id="mapid"></div>
	<p id="notestable"/>

	<script>
		function getURLParameter(name) {
		  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
		}

		var bbox = getURLParameter('bbox') || "-11.0133787,51.222,-5.6582362,55.636";
		var api_url = 'https://api.openstreetmap.org/api/0.6/changesets?bbox=' + bbox
		var fields = bbox.split(',');

		var minlong = fields[0] * 1;
		var minlat = fields[1] * 1;
		var maxlong = fields[2] * 1;
		var maxlat = fields[3] * 1;

		var mymap = L.map('mapid').setView([(maxlat + minlat)/2, (maxlong+minlong)/2], 8);;
		var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		});
		var min = new L.latLng(minlat, minlong);
		var max = new L.latLng(maxlat, maxlong);
		var bounds = new L.LatLngBounds([min, max]);
		mymap.fitBounds(bounds);
		OpenStreetMap_Mapnik.addTo(mymap);
		var polygon = L.polygon([[minlat, minlong],[minlat, maxlong],[maxlat, maxlong],[maxlat, minlong]],{fillopacity:0}).addTo(mymap);

		readTextFile(api_url, function (xmlDoc) {
			var changesets = xmlDoc.getElementsByTagName("changeset");

			var pattern = /(\d{4})\-(\d{2})\-(\d{2})\ (\d{2}):(\d{2}):(\d{2})\ UTC/;

			var txt = "<table id='notestable'><thead><th>Changeset ID</th><th>Time Uploaded</th><th>Changeset Comment</th><th>Source Details</th><th>Author</th><th>No of Comments</th></thead><tbody>";


			for (var i = 0; i < changesets.length; i++) {
				if (changesets[i].getAttribute('min_lat') * 1 > minlat,
					changesets[i].getAttribute('min_lon') * 1 > minlong,
					changesets[i].getAttribute('max_lat') * 1 < maxlat,
					changesets[i].getAttribute('max_lon') * 1 < maxlong) {

					var lat = ((changesets[i].getAttribute('min_lat') * 1) + (changesets[i].getAttribute('max_lat') * 1))/2;
					var lon = ((changesets[i].getAttribute('min_lon') * 1) + (changesets[i].getAttribute('max_lon') * 1))/2;

					txt += "<tr class='toplevel' id ='" + changesets[i].getAttribute('id') + "'><td><a href=http://www.openstreetmap.org/changeset/" + changesets[i].getAttribute('id') + ">" + changesets[i].getAttribute('id') + "</a></td>";
					var dt = new Date(changesets[i].getAttribute('created_at'));
					txt += "<td>" + dt.toLocaleDateString() + " " + dt.toLocaleTimeString() + "</td>";
					var tags = changesets[i].getElementsByTagName("tag");
					var comment, source, imagery, created, version;
					for (var j = 0; j < tags.length; j++) {
						if (tags[j].getAttribute('k') == "comment") {
							comment = tags[j].getAttribute('v');
						} 
						if (tags[j].getAttribute('k') == "source") { 
							source = tags[j].getAttribute('v');
						}
						if (tags[j].getAttribute('k') == "imagery_used") { 
							imagery = tags[j].getAttribute('v');
						}
						if (tags[j].getAttribute('k') == "created_by") { 
							created = tags[j].getAttribute('v');
						}
						if (tags[j].getAttribute('k') == "version") { 
							version = tags[j].getAttribute('v');
						}        
				}

					txt += "<td>";
					if (comment) { txt += comment + "</td><td>"; } else { txt += "</td><td>"; }
					if (created) { txt += created + " "; created = "";}
					if (version) { txt += "version " +version + " "; version = "";}
					txt += "<br/>"
					if (source) { txt += source + " "; source = "";}
					if (imagery) { txt += imagery + " "; imagery = "";}
					txt += "</td>";
					txt += "<td class='user'><a href=http://www.openstreetmap.org/user/" + changesets[i].getAttribute('user') + ">" + changesets[i].getAttribute('user') + "</a></td>";
					txt += "<td>" + changesets[i].getAttribute('comments_count') + "</td>";
					txt += "</tr>";
					
					var latLng = new L.latLng([lat, lon]);
					var marker = L.marker(latLng).addTo(mymap);
					marker.bindPopup("Changeset " + changesets[i].getAttribute('id') + "<br/>" + comment);
					comment = "";
				}
			}
			txt += "</tbody></table>";
			document.getElementById("notestable").innerHTML = txt;
		});

		function readTextFile(file, callback) {
			var rawFile = new XMLHttpRequest();
			rawFile.overrideMimeType("application/xml");
			rawFile.open("GET", file, true);
			rawFile.onreadystatechange = function() {
				if (rawFile.readyState === 4 && rawFile.status == "200") {
					callback(rawFile.responseXML);
				}
			};
			rawFile.send(null);
		}

	</script>
</body>
</html>
