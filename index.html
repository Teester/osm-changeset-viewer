<html>
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://npmcdn.com/leaflet.path.drag/src/Path.Drag.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-editable/1.0.0/Leaflet.Editable.min.js"></script>
	<style>
		body {
		  font: 15px Helvetica, arial, sans-serif;
		}

		table {
			border-collapse: collapse;
			width: 100%;
			background-color: #f2f2f2;
		}

		td, th {
			border-top: 1px solid #ddd;
			border-left: 1px solid #ddd;
			border-right: 1px solid #ddd;
			padding: 8px;
		}

		tr:hover, .selected {background-color: #ddd;}

		.toplevel {
			border: 0px;
		}

		.comment tr {
			background-color: #e2e2e2;
			border: 0px;
		}

		.subcomment {
			background-color: #f2f2f2;
			padding-left: 50px;
			font-size: 14px;
		}

		.user {
			font-size: 15px;
		}

		th {
			padding-top: 12px;
			padding-bottom: 12px;
			text-align: left;
			background-color: #4CAF50;
			color: white;
		}

		#mapid { height:400px; }

	</style>
	<title>OSM Changesets in Ireland</title>
</head>

<body>
	<h2 id="title">OSM Changesets</h2>
	<div id="mapid"></div>
	<p id="notestable"/>

	<script>
		function getURLParameter(name) {
		  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
		}

		function updateLocationBar(minlong, minlat, maxlong, maxlat) {
            var urlparameters = "?bbox=" +minlong + "," + minlat + "," +  maxlong + "," +  maxlat;
            var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + urlparameters;
            window.history.pushState({path:newurl},"",newurl);
        }
        
        function setupMap() {
			var bbox = getURLParameter('bbox') || "-11.0133787,51.222,-5.6582362,55.636";
			api_url = "https://api.openstreetmap.org/api/0.6/changesets?bbox=" + bbox
			var fields = bbox.split(',');

			var minlong = fields[0] * 1;
			var minlat = fields[1] * 1;
			var maxlong = fields[2] * 1;
			var maxlat = fields[3] * 1;

			mymap = L.map("mapid", {editable: true});
			var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			});
			var southwest = new L.latLng(minlat, minlong);
            var northeast = new L.latLng(maxlat, maxlong);
            bounds = new L.LatLngBounds([southwest, northeast]);

            updateLocationBar(minlong, minlat, maxlong, maxlat);
            
			mymap.fitBounds(bounds);
			
			OpenStreetMap_Mapnik.addTo(mymap);
			
			L.EditControl = L.Control.extend({});
            L.NewRectangleControl = L.EditControl.extend({});

            var rectangle = L.rectangle([southwest,northeast]).addTo(mymap);
            rectangle.enableEdit();

            rectangle.on("editable:dragend editable:vertex:dragend", function() { 
                bounds = this.getBounds();
                updateLocationBar(bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth());
                var bbox = getURLParameter("bbox")
                var newurl = "https://api.openstreetmap.org/api/0.6/changesets?bbox=" + bbox   
                mymap.fitBounds(bounds);
                readTextFile(newurl, parseText);
            });
		}

        var mymap;
        var api_url;
        var marker = new Array();
        var bounds;
        setupMap();
        
		console.log("parse",api_url);
        readTextFile(api_url, parseText);
        
		function parseText(xmlDoc) {
			for(i=0;i<marker.length;i++) {
                mymap.removeLayer(marker[i]);
            }  
            marker = [];
			
			var changesets = xmlDoc.getElementsByTagName("changeset");

			var pattern = /(\d{4})\-(\d{2})\-(\d{2})\ (\d{2}):(\d{2}):(\d{2})\ UTC/;

			var txt = "<table id='notestable'><thead><th>Changeset ID</th><th>Time Uploaded</th><th>Changeset Comment</th><th>Source Details</th><th>Author</th><th>No of Comments</th></thead><tbody>";
			var k = 0;
			for (var i = 0; i < changesets.length; i++) {
				if (changesets[i].getAttribute('min_lat') * 1 > bounds.getSouth(),
					changesets[i].getAttribute('min_lon') * 1 > bounds.getWest(),
					changesets[i].getAttribute('max_lat') * 1 < bounds.getNorth(),
					changesets[i].getAttribute('max_lon') * 1 < bounds.getEast()) {

					var lat = ((changesets[i].getAttribute('min_lat') * 1) + (changesets[i].getAttribute('max_lat') * 1))/2;
					var lon = ((changesets[i].getAttribute('min_lon') * 1) + (changesets[i].getAttribute('max_lon') * 1))/2;

					txt += "<tr class='toplevel' id ='" + changesets[i].getAttribute('id') + "'><td><a href=https://www.openstreetmap.org/changeset/" + changesets[i].getAttribute('id') + ">" + changesets[i].getAttribute('id') + "</a></td>";
					var dt = new Date(changesets[i].getAttribute('created_at'));
					txt += "<td>" + dt.toLocaleDateString() + " " + dt.toLocaleTimeString() + "</td>";
					var tags = changesets[i].getElementsByTagName("tag");
					var comment, source, imagery, created, version;
					for (var j = 0; j < tags.length; j++) {
						if (tags[j].getAttribute('k') == "comment") {
							comment = tags[j].getAttribute('v');
						} 
						if (tags[j].getAttribute('k') == "source") { 
							source = tags[j].getAttribute('v');
						}
						if (tags[j].getAttribute('k') == "imagery_used") { 
							imagery = tags[j].getAttribute('v');
						}
						if (tags[j].getAttribute('k') == "created_by") { 
							created = tags[j].getAttribute('v');
						}
						if (tags[j].getAttribute('k') == "version") { 
							version = tags[j].getAttribute('v');
						}        
				}

					txt += "<td>";
					if (comment) { txt += comment + "</td><td>"; } else { txt += "</td><td>"; }
					if (created) { txt += created + " "; created = "";}
					if (version) { txt += "version " +version + " "; version = "";}
					txt += "<br/>"
					if (source) { txt += source + " "; source = "";}
					if (imagery) { txt += imagery + " "; imagery = "";}
					txt += "</td>";
					txt += "<td class='user'><a href='https://www.openstreetmap.org/user/" + changesets[i].getAttribute('user') + "'>" + changesets[i].getAttribute('user') + "</a></td>";
					txt += "<td>" + changesets[i].getAttribute('comments_count') + "</td>";
					txt += "</tr>";
					
					var latLng = new L.latLng([lat, lon]);
					var myMarker = new L.marker(latLng);           
					
					myMarker.bindPopup("<a href='https://www.openstreetmap.org/changeset/" + changesets[i].getAttribute('id') + "'>Changeset " + changesets[i].getAttribute('id') + "</a><br/>" + comment);
					marker.push(myMarker);
					mymap.addLayer(marker[k]);
					k++;
					comment = "";
				}
			}
			txt += "</tbody></table>";
			document.getElementById("notestable").innerHTML = txt;
		}

		function readTextFile(file, callback) {
			var rawFile = new XMLHttpRequest();
			rawFile.overrideMimeType("application/xml");
			rawFile.open("GET", file, true);
			rawFile.onreadystatechange = function() {
				if (rawFile.readyState === 4 && rawFile.status == "200") {
					callback(rawFile.responseXML);
				}
			};
			rawFile.send(null);
		}

	</script>
</body>
</html>
